name: CI Pipeline

permissions:
  contents: write

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build JAR
        working-directory: .
        run: mvn clean package -DskipTests

      - name: Login to Docker Hub
        uses: docker/login-action@v3.6.0
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6.18.0
        with:
          file: ./Dockerfile
          tags: briankimathi/task-manager:${{ github.sha }}
          push: true

      - name: Updating image tag inside manifest files
        run: |
          pip install yq
          yq -Yi '.spec.template.spec.containers[0].image = "briankimathi/task-manager:'${GITHUB_SHA}'"' ./manifests/app/deployment.yaml

      - name: Commit and Push the code
        run: |
          git config user.name "Brian Kimathi"
          git config user.email "kimathibrian71@gmail.com"
          git add manifests/app/deployment.yaml
          git commit -m "Updating image tag inside manifest using actions"
          git push origin main

  deploy-app:
    needs: build-and-push
    runs-on: self-hosted

    steps:
      - name: Installing Argo CD CLI in Runner
        run: |
          echo "Checking network connectivity to Argo CD Server..."
          # This checks if the runner can even see the Argo CD service
          ping -c 2 argocd-server.argocd.svc.cluster.local || echo "DNS lookup failed, but proceeding with download..."
          
          echo "Downloading Argo CD CLI..."
          # Using the full DNS path for the download as well
          curl -ksSL -o argocd-linux-amd64 https://argocd-server.argocd.svc.cluster.local/download/argocd-linux-amd64
          
          sudo chmod 755 argocd-linux-amd64
          sudo mv ./argocd-linux-amd64 /usr/local/bin/argocd
          echo "Argo CD CLI installed successfully: $(argocd version --client --short)"

      - name: Login via argocd cli
        env:
          ARGOCD_PASS: ${{ secrets.ARGOCD_PASSWORD }}
        run: |
          echo "Attempting login to Argo CD..."
          # Check if secret is empty without printing the actual value
          if [ -z "$ARGOCD_PASS" ]; then
            echo "ERROR: ARGOCD_PASSWORD secret is empty! Check your GitHub Secrets."
            exit 1
          fi
          
          argocd login argocd-server.argocd.svc.cluster.local \
            --insecure \
            --grpc-web \
            --username admin \
            --password "$ARGOCD_PASS"
          echo "Login step completed."

      - name: Sync argocd application
        run: |
          echo "Starting sync for application: task-manager"
          argocd app sync task-manager
          echo "Sync command sent. Checking status..."
          argocd app get task-manager